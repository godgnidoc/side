#!/bin/bash -e

ncc build src/side.ts -q -m --v8-cache --no-source-map-register -o build/
mv build/index.js build/side.js
sed -i -e '1s|^|#!/usr/bin/env node\n|' build/side.js
chmod +x build/side.js
ln -rfs build/side.js build/side

ncc build src/dist.ts -q -m --v8-cache --no-source-map-register -o build/
mv build/index.js build/dist.js
sed -i -e '1s|^|#!/usr/bin/env node\n|' build/dist.js
chmod +x build/dist.js
ln -rfs build/dist.js build/dist

build/side vset \
  -f json \
  -o build/package.json \
  build/package.json \
  version=\"$(build/side vget package.json version)\"

build/side vset \
  -f json \
  -o build/package.json \
  build/package.json \
  revision=\"$(build/side vget build/build-info.json revision)\"